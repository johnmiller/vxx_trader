/*! vxx_trader 2014-12-10 */
function read(a){var b=q.defer(),c=csv.parse({delimiter:",",columns:!0}),d=[];return c.on("readable",function(){for(;row=c.read();)d.push(row)}).on("finish",function(){b.resolve(d)}),fs.createReadStream(a).pipe(c),b.promise}function buildQuotes(a){return parser.read(a).then(function(a){return a.map(toQuote)}).then(function(a){return enhance(a),a})}function enhance(a){for(var b=a[0],c=0;c<=a.length-1;c++){var d=a[c];b&&(d.open_change=subtr(d.adj_open,b.adj_close),d.open_change_perc=div(d.open_change,b.adj_close),d.close_change=subtr(d.adj_close,b.adj_close),d.close_change_perc=div(d.close_change,b.adj_close),d.high_change=subtr(d.adj_high,b.adj_close),d.high_change_perc=div(d.high_change,b.adj_close),d.low_change=subtr(d.adj_low,b.adj_close),d.low_change_perc=div(d.low_change,b.adj_close)),b=d}}function toQuote(a){var b={date:parseDate(a.Date),open:parseFloat(a.Open),high:parseFloat(a.High),low:parseFloat(a.Low),close:parseFloat(a.Close),volume:parseFloat(a.Volume),adj_close:parseFloat(a["Adj Close"])};return adjustForSplits(b),b}function adjustForSplits(a){var b=a.adj_close/a.close;a.adj_open=mult(a.open,b),a.adj_high=mult(a.high,b),a.adj_low=mult(a.low,b)}function parseDate(a){var b=a.substring(0,4),c=a.substring(5,7),d=a.substring(8,10);return new Date(b,c,d)}function subtr(a,b){return parseFloat((a-b).toFixed(2))}function mult(a,b){return parseFloat((a*b).toFixed(2))}function div(a,b){return parseFloat((a/b).toFixed(2))}var fs=require("fs"),csv=require("csv"),q=require("q");exports.read=read;var parser=require("./history-parser"),q=require("q");exports.buildQuotes=buildQuotes;var parser=require("./quote-builder");parser.buildQuotes(__dirname+"/vxx.csv").then(function(a){console.log(a),console.log(a.length),console.log(a[a.length-1])});